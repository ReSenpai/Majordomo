## Запуск, остановка, перезагрузка конфигурации ([Ссылка](https://nginx.org/ru/docs/beginners_guide.html))

#### По умолчанию, конфигурационный файл называется ```nginx.conf``` и расположен в каталоге ```/usr/local/nginx/conf```, ```/etc/nginx``` или ```/usr/local/etc/nginx```.

* ```systemctl start nginx``` - запустить службу
* ```systemctl stop nginx``` - остановить службу
* ```systemctl restart nginx``` - перезагрузить службу

Чтобы запустить nginx, нужно выполнить исполняемый файл. Когда nginx запущен, им можно управлять, вызывая исполняемый файл с параметром -s. Используйте следующий синтаксис:

* ```nginx -s сигнал```

Где сигнал может быть одним из следующих:

* ```stop``` - быстрое завершение
* ```quit``` - плавное завершение
* ```reload``` - перезагрузка конфигурационного файла(для применения изменений в конфигурационном файле)
* ```reopen``` - переоткрытие лог-файлов(что это?)

Для перезагрузки и выключение команды должны быть выполнены под тем же пользователем, под которым был запущен nginx.

Посылать сигналы процессам nginx можно также средствами Unix, такими как утилита kill. В этом случае сигнал отправляется напрямую процессу с данным ID. ID главного процесса nginx записывается по умолчанию в файл nginx.pid в каталоге /usr/local/nginx/logs или /var/run. Например, если ID главного процесса равен 1628, для отправки сигнала QUIT, который приведёт к плавному завершению nginx, нужно выполнить:

* ```kill -s QUIT 1628```

Для просмотра списка всех запущенных процессов nginx может быть использована утилита ps, например, следующим образом:

* ```ps -ax | grep nginx```

Дополнительная информация об отправке сигналов процессам nginx ниже
### [Дополнителная информация](https://nginx.org/ru/docs/control.html) 


## Структура конфигурационного файла

Nginx состоит из модулей, которые настраиваются дерективами, указанными в конфигурационном файле. Дерективы делятся на простые и блочные.

* Простая директива состоит из имени и параметров, разделённых пробелами, и оканчивается точкой с запятой ```(;)```
* Блочная директива устроена так же, как и простая директива, но вместо точки с запятой после имени и параметров следует набор дополнительных инструкций, помещённых внутри фигурных скобок ({ и }). Если у блочной директивы внутри фигурных скобок можно задавать другие директивы, то она называется контекстом ,примеры:

* ```events { ... }``` - синтаксис, ```main``` - контекст.

Коментарии в конфиге оставляются, как и в обычном баше, через решетку  ```#```

### Раздача статического содержимого 

Одна из важных задач конфигурации nginx - это раздача файлов, таких как изоображения и статические HTML страницы. Рассмотрим пример, в котором в зависимости от запроса файлы будут раздаваться из разных локальных каталогов: ```/data/www```, который содержит HTML-файлы, и ```/data/images```, содержащий файлы с изоображениями.

Для этого потребуется отредактировать конфигурационный файл и настроить блок ```server``` внури блока ```http```с двумя блоками ```location```.

1. Создаем каталог ```/data/www``` и помещаем в него файл ```index.html``` с любым текстовым содержанием, а также каталог ```/data/images``` и положим в него несколько изоображений.

2. Открываем конфигурационный файл. Конфиг по умолчанию уже включает в себя несколько примеров блока ```server```, по большей части закомментированных.

```conf
http {
    server {
    }
}
```

В общем случае конфигурационный файл может содержать несколько блоков server, различаемых по портам, на которых они слушают, и по имени сервера. 

```conf
server {
    listen      80;
    server_name example.org www.example.org;
    ...
}

server {
    listen      80;
    server_name example.net www.example.net;
    ...
}

server {
    listen      80;
    server_name example.com www.example.com;
    ...
}
```

3. Определив, какой server будет обрабатывать запрос, nginx сравнивает URI, указанный в заголовке запроса, с параметрами директив location, определённых внутри блока server.

```conf
server {
    location / {
        root /data/www;
    }
}
```

Этот блок location задаёт “/” в качестве префикса, который сравнивается с URI из запроса. Для подходящих запросов добавлением URI к пути, указанному в директиве root, то есть, в данном случае, к /data/www, получается путь к запрашиваемому файлу в локальной файловой системе.

4. Далее, добавьте второй блок location:

```conf
location /images/ {
    root /data;
}
```

Он будет давать совпадение с запросами, начинающимися с /images/ (location / для них тоже подходит, но указанный там префикс короче).

5. Итоговая конфигурация блока server должна выглядеть следующим образом:

```conf
server {
    location / {
        root /data/www;
    }

    location /images/ {
        root /data;
    }
}
```

Это уже работающая конфигурация сервера, слушающего на стандартном порту 80 и доступного на локальном компьютере по адресу http://localhost/. В ответ на запросы, URI которых начинаются с /images/, сервер будет отправлять файлы из каталога /data/images. Например, на запрос http://localhost/images/example.png nginx отправит в ответ файл /data/images/example.png.

Если же этот файл не существует, nginx отправит ответ, указывающий на ошибку 404. Запросы, URI которых не начинаются на /images/, будут отображены на каталог /data/www. Например, в результате запроса http://localhost/some/example.html в ответ будет отправлен файл /data/www/some/example.html.

Чтобы применить новую конфигурацию, запустите nginx, если он ещё не запущен, или отправьте сигнал reload главному процессу nginx, выполнив:

* ```nginx -s reload```
> В случае если что-то работает не как ожидалось, можно попытаться выяснить причину с помощью файлов ```access.log``` и ```error.log``` из каталога ```/usr/local/nginx/logs``` или ```/var/log/nginx```.


### Настройка простого прокси сервера

Частым применением nginx ялвяется использование его в качестве прокси-сервера, то есть сервера, который принимает запросы, перенаправляет их на проксируемые сервера, получает ответы от них и отправляет их клиенту.

Мы настроим базовый прокси-сервер, который будет обслуживать запросы изоображений из локального каталога и отправлять все остальные запросы на проксируемый сервер. В этом примере оба сервера будут работат ьв рамках одного экземпляра nginx.



[Вернутся назад](solution.md)

[На главную](README.md)
